<template>
  <b-badge
    v-bind:variant="mutableVariant"
    class="pull-right timebadage"
  >
  {{disp}}
  </b-badge>
</template>

<style scoped>
.timebadage {
  margin-right: 5px
}
</style>
<script>
import moment from 'moment'

export default {
  namme: 'TimeBadge',
  props: {
    starttime: {
      type: String,
      default: '1970-01-01T00:00:00.000Z',
    },
    endtime: {
      type: String,
      default: '1970-01-01T00:00:00.000Z',
    },
    text: {
      type: String,
      default: '0s',
    },
    variant: {
      type: String,
      default: 'info'
    },
    interval: {
      type: Number,
      default: 60000,
    }
  },
  mounted: function() {
    this.onBadgeUpdate();
  },
  data: function () {
    return {
      disp: this.text,
      mutableVariant: this.variant
    }
  },
  methods: {
    formatDurationShort(duration) {
      let timeText = '';
      if (duration.days()) {
        timeText += `${duration.days()}d ${duration.hours()}h ${duration.minutes()}m ${duration.seconds()}s`;
      } else if (duration.hours()) {
        timeText += `${duration.hours()}h ${duration.minutes()}m ${duration.seconds()}s`;
      } else if (duration.minutes()) {
        timeText += `${duration.minutes()}m ${duration.seconds()}s`;
      } else {
        timeText += `${duration.seconds()}s`;
      }
      return timeText;
    },
    formatTimer(diff) {
      let timeLeft = diff;
      const stringArray = [];

      [[86400000, 'd'], [3600000, 'h'], [60000, 'm'], [1000, 's']]
        .forEach(([unit, suffix]) => {
          const time = Math.floor(timeLeft / unit);
          const first = stringArray.length === 0;
          if (!first || time > 0) {
            stringArray.push(time.toString()
              .padStart(first ? 1 : 2, '0') + suffix);
          }
          timeLeft -= time * unit;
        });
      return stringArray.join(' ');
    },
    onBadgeUpdate () {
      const start = new Date(this.starttime).getTime() / 1000;
      const end = new Date(this.endtime).getTime() / 1000;

      let diffactivate;
      let durationactivate;

      // Get the diff and duration since "start"
      if (typeof start !== 'undefined' && start !== false) {
        diffactivate = moment().diff(moment.unix(start)) * -1;
        durationactivate = moment.duration(diffactivate, 'milliseconds');
      }

      // Get the diff and duration until "end"
      const diff = moment().diff(moment.unix(end)) * -1;
      const duration = moment.duration(diff, 'milliseconds');

      // Format based on there being no end time, being after the end, or being before the start
      if (!this.endtime) {
        this.disp = `${diffactivate > 0 ? '-' : ''}${this.formatTimer(Math.abs(diffactivate))}`;
      } else if (typeof diffactivate !== 'undefined' && diffactivate > 0) {
        this.mutableVariant = 'info';
        this.disp = `Starts in: ${this.formatDurationShort(durationactivate)}`;
      } else if (diff < 0) {
        this.mutableVariant = 'default';
        this.disp = `Expired: ${this.formatDurationShort(duration)}`;
      } else {
        if (diff < 600000) { // 0 min to 10 min
          this.mutableVariant = 'danger';
        } else if (diff < 1800000) { // 10 min to 30 min
          this.mutableVariant = 'warning';
        } else if (diff > 1800000) { // 30 min to 1 hour
          this.mutableVariant = 'success';
        }
        this.disp = this.formatTimer(diff);
      }
      setTimeout(this.onBadgeUpdate, this.interval);
    }
  },
}

</script>
